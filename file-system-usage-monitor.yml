---
- name: Monitor File Systems
  hosts: all
  vars:
    threshold_limit: 80
  tasks:
    - name: Check File Systems
      shell: df -h
      register: fs_info
    - name: Parse File System Data
      set_fact:
        fs_data: "{{ fs_info.stdout_lines[1:] | map('regex_replace', '( )+', ',') | map('split', ',') | list }}"
    - name: Check Threshold Limit
      set_fact:
        alert_fs: "{{ fs_data | selectattr('4', 'match', threshold_limit) | list }}"
    - name: Send Alert Email
      when: alert_fs | length > 0
      command: echo "File system {{ item.5 }} on {{ inventory_hostname }} is above threshold limit of {{ threshold_limit }}%" | sendmail -s "File System Alert" youremail@example.com
      loop: "{{ alert_fs }}"
